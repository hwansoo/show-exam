<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÏãúÌóò Î¨∏Ï†ú Ïó∞Ïäµ ÏÑúÎπÑÏä§</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
        }

        .exam-selector {
            margin-bottom: 30px;
        }

        .exam-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .exam-card {
            background: linear-gradient(145deg, #f0f4f8, #e2e8f0);
            border: none;
            border-radius: 12px;
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }

        .exam-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
            background: linear-gradient(145deg, #e2e8f0, #cbd5e0);
        }

        .exam-card h3 {
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 1.3rem;
        }

        .exam-card p {
            color: #718096;
            font-size: 0.95rem;
        }

        .question-container {
            margin-bottom: 30px;
            padding: 25px;
            background: #f8fafc;
            border-radius: 12px;
            border-left: 5px solid #667eea;
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .question-number {
            background: #667eea;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
        }

        .question-score {
            background: #38a169;
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.9rem;
        }

        .question-text {
            font-size: 1.1rem;
            margin-bottom: 20px;
            line-height: 1.7;
        }

        .sub-questions {
            margin-left: 20px;
            border-left: 3px solid #e2e8f0;
            padding-left: 20px;
        }

        .sub-question {
            margin-bottom: 20px;
        }

        .options {
            margin: 15px 0;
        }

        .option {
            display: flex;
            align-items: center;
            margin: 10px 0;
            padding: 12px;
            border-radius: 8px;
            transition: background-color 0.2s;
        }

        .option:hover {
            background-color: #f1f5f9;
        }

        .option input {
            margin-right: 12px;
            transform: scale(1.2);
        }

        .option label {
            cursor: pointer;
            flex: 1;
        }

        .text-answer {
            width: 100%;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
            resize: vertical;
            min-height: 100px;
        }

        .text-answer:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: linear-gradient(145deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.3s ease;
            margin: 10px 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .results-container {
            margin-top: 30px;
        }

        .score-display {
            text-align: center;
            padding: 30px;
            background: linear-gradient(145deg, #48bb78, #38a169);
            color: white;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .score-display h2 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .answer-review {
            margin-bottom: 25px;
            padding: 20px;
            border-radius: 12px;
            border-left: 5px solid #cbd5e0;
        }

        .answer-review.correct {
            background: #f0fff4;
            border-left-color: #48bb78;
        }

        .answer-review.incorrect {
            background: #fff5f5;
            border-left-color: #f56565;
        }

        .answer-review.partial {
            background: #fffbf0;
            border-left-color: #ed8936;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .status-badge.correct {
            background: #c6f6d5;
            color: #22543d;
        }

        .status-badge.incorrect {
            background: #fed7d7;
            color: #742a2a;
        }

        .status-badge.partial {
            background: #feebc8;
            color: #744210;
        }

        .explanation {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 4px solid #667eea;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s ease;
        }

        .api-key-input {
            margin-bottom: 20px;
            padding: 20px;
            background: #f0f4f8;
            border-radius: 10px;
        }

        .api-key-input input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            margin-top: 10px;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .card {
                padding: 20px;
            }
            
            .question-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìö ÏãúÌóò Î¨∏Ï†ú Ïó∞Ïäµ ÏÑúÎπÑÏä§</h1>
            <p>Îã§ÏñëÌïú Ïú†ÌòïÏùò Î¨∏Ï†úÎ•º ÌíÄÍ≥† Ïã§Î†•ÏùÑ Ìñ•ÏÉÅÏãúÏºúÎ≥¥ÏÑ∏Ïöî!</p>
        </div>

        <!-- API Key ÏÑ§Ï†ï -->
        <div class="card api-key-input" id="apiKeySection">
            <h3>üîë OpenAI API ÌÇ§ ÏÑ§Ï†ï</h3>
            <p>Ï£ºÍ¥ÄÏãù Î¨∏Ï†ú Ï±ÑÏ†êÏùÑ ÏúÑÌï¥ OpenAI API ÌÇ§Í∞Ä ÌïÑÏöîÌï©ÎãàÎã§.</p>
            <input type="password" id="apiKeyInput" placeholder="OpenAI API ÌÇ§Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî">
            <button class="btn" onclick="saveApiKey()">Ï†ÄÏû•</button>
        </div>

        <!-- ÏãúÌóò ÏÑ†ÌÉù ÌôîÎ©¥ -->
        <div class="card exam-selector" id="examSelector">
            <h2>üìã ÏãúÌóò ÏÑ†ÌÉù</h2>
            <div class="exam-grid" id="examGrid">
                <!-- ÏãúÌóò Î™©Î°ùÏù¥ Ïó¨Í∏∞Ïóê ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ±Îê©ÎãàÎã§ -->
            </div>
        </div>

        <!-- Î¨∏Ï†ú ÌíÄÏù¥ ÌôîÎ©¥ -->
        <div class="card hidden" id="examContainer">
            <div id="examHeader">
                <h2 id="examTitle"></h2>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <p>Î¨∏Ï†ú <span id="currentQuestion">1</span> / <span id="totalQuestions">10</span></p>
            </div>
            
            <div id="questionContainer">
                <!-- Î¨∏Ï†úÎì§Ïù¥ Ïó¨Í∏∞Ïóê ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ±Îê©ÎãàÎã§ -->
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn" onclick="submitAnswers()" id="submitBtn">ÎãµÏïà Ï†úÏ∂ú</button>
                <button class="btn" onclick="resetExam()">Ï≤òÏùåÏúºÎ°ú</button>
            </div>
        </div>

        <!-- Í≤∞Í≥º ÌôîÎ©¥ -->
        <div class="card hidden" id="resultsContainer">
            <div class="score-display" id="scoreDisplay">
                <h2 id="finalScore"></h2>
                <p id="scoreDescription"></p>
            </div>
            
            <div id="answerReviews">
                <!-- ÎãµÏïà Í≤ÄÌÜ†Í∞Ä Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§ -->
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn" onclick="resetExam()">Îã§Ïãú ÏãúÏûë</button>
            </div>
        </div>
    </div>

    <script>
        // ÏÉòÌîå ÏãúÌóò Îç∞Ïù¥ÌÑ∞
        const examData = {
            "math_basic": {
                "title": "Í∏∞Ï¥à ÏàòÌïô",
                "description": "Í∏∞Î≥∏Ï†ÅÏù∏ ÏàòÌïô Í∞úÎÖêÏùÑ Îã§Î£®Îäî Î¨∏Ï†úÎì§",
                "questions": [
                    {
                        "id": 1,
                        "type": "single_choice",
                        "question": "Îã§Ïùå Ï§ë $\\sqrt{16}$Ïùò Í∞íÏùÄ?",
                        "options": ["2", "4", "8", "16"],
                        "correct_answer": 1,
                        "score": 10,
                        "explanation": "$\\sqrt{16} = 4$ÏûÖÎãàÎã§. 16Ïùò Ï†úÍ≥±Í∑ºÏùÄ 4ÏûÖÎãàÎã§."
                    },
                    {
                        "id": 2,
                        "type": "multiple_choice",
                        "question": "Îã§Ïùå Ï§ë ÏÜåÏàòÏù∏ Í≤ÉÏùÑ Î™®Îëê Í≥†Î•¥ÏÑ∏Ïöî.",
                        "options": ["2", "3", "4", "5", "6", "7"],
                        "correct_answers": [0, 1, 3, 5],
                        "score": 15,
                        "explanation": "ÏÜåÏàòÎäî 1Í≥º ÏûêÍ∏∞ ÏûêÏã†ÏúºÎ°úÎßå ÎÇòÎàÑÏñ¥ÏßÄÎäî ÏûêÏó∞ÏàòÏûÖÎãàÎã§. 2, 3, 5, 7Ïù¥ ÏÜåÏàòÏûÖÎãàÎã§."
                    },
                    {
                        "id": 3,
                        "type": "true_false",
                        "question": "$\\pi$Îäî Î¨¥Î¶¨ÏàòÏù¥Îã§.",
                        "correct_answer": true,
                        "score": 10,
                        "explanation": "$\\pi$Îäî Î¨¥Î¶¨ÏàòÏûÖÎãàÎã§. Ïú†ÌïúÏÜåÏàòÎÇò ÏàúÌôòÏÜåÏàòÎ°ú ÌëúÌòÑÌï† Ïàò ÏóÜÏäµÎãàÎã§."
                    },
                    {
                        "id": 4,
                        "type": "short_answer",
                        "question": "$2x + 5 = 13$Ïùº Îïå, $x$Ïùò Í∞íÏùÑ Íµ¨ÌïòÏÑ∏Ïöî.",
                        "correct_answer": "4",
                        "score": 15,
                        "explanation": "$2x + 5 = 13$ÏóêÏÑú $2x = 8$Ïù¥ÎØÄÎ°ú $x = 4$ÏûÖÎãàÎã§."
                    },
                    {
                        "id": 5,
                        "type": "essay",
                        "question": "ÌîºÌÉÄÍ≥†ÎùºÏä§ Ï†ïÎ¶¨Î•º ÏÑ§Î™ÖÌïòÍ≥†, ÏßÅÍ∞ÅÏÇºÍ∞ÅÌòïÏóêÏÑú ÎπóÎ≥ÄÏùò Í∏∏Ïù¥Í∞Ä 5, Ìïú Î≥ÄÏùò Í∏∏Ïù¥Í∞Ä 3Ïùº Îïå Îã§Î•∏ Ìïú Î≥ÄÏùò Í∏∏Ïù¥Î•º Íµ¨ÌïòÎäî Í≥ºÏ†ïÏùÑ ÏÑúÏà†ÌïòÏÑ∏Ïöî.",
                        "score": 20,
                        "explanation": "ÌîºÌÉÄÍ≥†ÎùºÏä§ Ï†ïÎ¶¨: $a^2 + b^2 = c^2$. Ï£ºÏñ¥ÏßÑ Ï°∞Í±¥ÏóêÏÑú $3^2 + b^2 = 5^2$Ïù¥ÎØÄÎ°ú $b^2 = 16$, Îî∞ÎùºÏÑú $b = 4$ÏûÖÎãàÎã§."
                    }
                ]
            },
            "physics_basic": {
                "title": "Í∏∞Ï¥à Î¨ºÎ¶¨Ìïô",
                "description": "Î¨ºÎ¶¨ÌïôÏùò Í∏∞Î≥∏ Í∞úÎÖêÍ≥º Í≥µÏãùÎì§",
                "questions": [
                    {
                        "id": 1,
                        "type": "single_choice",
                        "question": "ÏûêÏú†ÎÇôÌïòÌïòÎäî Î¨ºÏ≤¥Ïùò Í∞ÄÏÜçÎèÑÎäî ÎåÄÎûµ ÏñºÎßàÏù∏Í∞Ä?",
                        "options": ["$9.8 \\text{ m/s}$", "$9.8 \\text{ m/s}^2$", "$98 \\text{ m/s}^2$", "$0.98 \\text{ m/s}^2$"],
                        "correct_answer": 1,
                        "score": 10,
                        "explanation": "ÏßÄÍµ¨ÏóêÏÑú Ï§ëÎ†•Í∞ÄÏÜçÎèÑÎäî ÏïΩ $9.8 \\text{ m/s}^2$ÏûÖÎãàÎã§."
                    },
                    {
                        "id": 2,
                        "type": "compound",
                        "question": "Ïö¥Îèô Î≤ïÏπôÏóê Í¥ÄÌïú Î¨∏Ï†ú",
                        "score": 30,
                        "sub_questions": [
                            {
                                "id": "2a",
                                "type": "true_false",
                                "question": "Îâ¥ÌÑ¥Ïùò Ï†ú1Î≤ïÏπôÏùÄ Í¥ÄÏÑ±Ïùò Î≤ïÏπôÏù¥Îã§.",
                                "correct_answer": true,
                                "score": 10,
                                "explanation": "Îâ¥ÌÑ¥Ïùò Ï†ú1Î≤ïÏπôÏùÄ Í¥ÄÏÑ±Ïùò Î≤ïÏπôÏúºÎ°ú Î∂àÎ¶ΩÎãàÎã§."
                            },
                            {
                                "id": "2b",
                                "type": "short_answer",
                                "question": "ÏßàÎüâÏù¥ 2kgÏù∏ Î¨ºÏ≤¥Ïóê 4NÏùò ÌûòÏùÑ Í∞ÄÌñàÏùÑ ÎïåÏùò Í∞ÄÏÜçÎèÑÎäî? (Îã®ÏúÑ: $\\text{m/s}^2$)",
                                "correct_answer": "2",
                                "score": 10,
                                "explanation": "$F = ma$ÏóêÏÑú $a = F/m = 4/2 = 2 \\text{ m/s}^2$ÏûÖÎãàÎã§."
                            },
                            {
                                "id": "2c",
                                "type": "essay",
                                "question": "Îâ¥ÌÑ¥Ïùò Ï†ú3Î≤ïÏπôÏùÑ ÏÑ§Î™ÖÌïòÍ≥† ÏùºÏÉÅÏÉùÌôúÏóêÏÑúÏùò ÏòàÎ•º ÌïòÎÇò Îì§Ïñ¥Î≥¥ÏÑ∏Ïöî.",
                                "score": 10,
                                "explanation": "ÏûëÏö©-Î∞òÏûëÏö©Ïùò Î≤ïÏπôÏûÖÎãàÎã§. Ïòà: Í±∏ÏùÑ Îïå Î∞úÎ°ú ÎïÖÏùÑ Î∞ÄÎ©¥ ÎïÖÎèÑ Î∞úÏùÑ Í∞ôÏùÄ ÌÅ¨Í∏∞Î°ú Î∞ÄÏñ¥Ï§çÎãàÎã§."
                            }
                        ]
                    }
                ]
            }
        };

        let currentExam = null;
        let userAnswers = {};
        let apiKey = localStorage.getItem('openai_api_key') || '';

        // Ï¥àÍ∏∞Ìôî
        document.addEventListener('DOMContentLoaded', function() {
            if (apiKey) {
                document.getElementById('apiKeyInput').value = apiKey;
                document.getElementById('apiKeySection').style.display = 'none';
            }
            loadExamList();
            renderMath();
        });

        function renderMath() {
            if (window.renderMathInElement) {
                renderMathInElement(document.body, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false}
                    ]
                });
            }
        }

        function saveApiKey() {
            const key = document.getElementById('apiKeyInput').value.trim();
            if (key) {
                apiKey = key;
                localStorage.setItem('openai_api_key', key);
                document.getElementById('apiKeySection').style.display = 'none';
                alert('API ÌÇ§Í∞Ä Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.');
            } else {
                alert('Ïú†Ìö®Ìïú API ÌÇ§Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
            }
        }

        function loadExamList() {
            const examGrid = document.getElementById('examGrid');
            examGrid.innerHTML = '';

            for (const [key, exam] of Object.entries(examData)) {
                const examCard = document.createElement('div');
                examCard.className = 'exam-card';
                examCard.onclick = () => startExam(key);
                
                examCard.innerHTML = `
                    <h3>${exam.title}</h3>
                    <p>${exam.description}</p>
                    <p><strong>Î¨∏Ï†ú Ïàò:</strong> ${getTotalQuestionCount(exam.questions)}</p>
                `;
                
                examGrid.appendChild(examCard);
            }
        }

        function getTotalQuestionCount(questions) {
            let count = 0;
            questions.forEach(q => {
                if (q.type === 'compound') {
                    count += q.sub_questions.length;
                } else {
                    count += 1;
                }
            });
            return count;
        }

        function startExam(examKey) {
            currentExam = examData[examKey];
            userAnswers = {};
            
            document.getElementById('examSelector').classList.add('hidden');
            document.getElementById('examContainer').classList.remove('hidden');
            document.getElementById('resultsContainer').classList.add('hidden');
            
            document.getElementById('examTitle').textContent = currentExam.title;
            document.getElementById('totalQuestions').textContent = getTotalQuestionCount(currentExam.questions);
            
            renderQuestions();
            updateProgress();
        }

        function renderQuestions() {
            const container = document.getElementById('questionContainer');
            container.innerHTML = '';
            
            let questionNumber = 1;
            
            currentExam.questions.forEach((question, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question-container';
                
                if (question.type === 'compound') {
                    questionDiv.innerHTML = `
                        <div class="question-header">
                            <span class="question-number">${questionNumber}</span>
                            <span class="question-score">${question.score}Ï†ê</span>
                        </div>
                        <div class="question-text">${question.question}</div>
                        <div class="sub-questions">
                            ${question.sub_questions.map((subQ, subIndex) => {
                                const subQuestionHtml = renderSubQuestion(subQ, `${question.id}-${subIndex}`, questionNumber + subIndex);
                                return `<div class="sub-question">${subQuestionHtml}</div>`;
                            }).join('')}
                        </div>
                    `;
                    questionNumber += question.sub_questions.length;
                } else {
                    questionDiv.innerHTML = renderSingleQuestion(question, questionNumber);
                    questionNumber++;
                }
                
                container.appendChild(questionDiv);
            });
            
            setTimeout(renderMath, 100);
        }

        function renderSingleQuestion(question, questionNumber) {
            const questionId = question.id;
            
            let optionsHtml = '';
            
            switch (question.type) {
                case 'single_choice':
                    optionsHtml = `
                        <div class="options">
                            ${question.options.map((option, index) => `
                                <div class="option">
                                    <input type="radio" id="q${questionId}_${index}" name="q${questionId}" value="${index}">
                                    <label for="q${questionId}_${index}">${option}</label>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    break;
                    
                case 'multiple_choice':
                    optionsHtml = `
                        <div class="options">
                            ${question.options.map((option, index) => `
                                <div class="option">
                                    <input type="checkbox" id="q${questionId}_${index}" name="q${questionId}" value="${index}">
                                    <label for="q${questionId}_${index}">${option}</label>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    break;
                    
                case 'true_false':
                    optionsHtml = `
                        <div class="options">
                            <div class="option">
                                <input type="radio" id="q${questionId}_true" name="q${questionId}" value="true">
                                <label for="q${questionId}_true">Ï∞∏</label>
                            </div>
                            <div class="option">
                                <input type="radio" id="q${questionId}_false" name="q${questionId}" value="false">
                                <label for="q${questionId}_false">Í±∞Ïßì</label>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'short_answer':
                case 'essay':
                    optionsHtml = `
                        <textarea class="text-answer" id="q${questionId}" placeholder="ÎãµÏïàÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî..."></textarea>
                    `;
                    break;
            }
            
            return `
                <div class="question-header">
                    <span class="question-number">${questionNumber}</span>
                    <span class="question-score">${question.score}Ï†ê</span>
                </div>
                <div class="question-text">${question.question}</div>
                ${optionsHtml}
            `;
        }

        function renderSubQuestion(subQuestion, questionId, questionNumber) {
            let optionsHtml = '';
            
            switch (subQuestion.type) {
                case 'single_choice':
                    optionsHtml = `
                        <div class="options">
                            ${subQuestion.options.map((option, index) => `
                                <div class="option">
                                    <input type="radio" id="q${questionId}_${index}" name="q${questionId}" value="${index}">
                                    <label for="q${questionId}_${index}">${option}</label>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    break;
                    
                case 'multiple_choice':
                    optionsHtml = `
                        <div class="options">
                            ${subQuestion.options.map((option, index) => `
                                <div class="option">
                                    <input type="checkbox" id="q${questionId}_${index}" name="q${questionId}" value="${index}">
                                    <label for="q${questionId}_${index}">${option}</label>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    break;
                    
                case 'true_false':
                    optionsHtml = `
                        <div class="options">
                            <div class="option">
                                <input type="radio" id="q${questionId}_true" name="q${questionId}" value="true">
                                <label for="q${questionId}_true">Ï∞∏</label>
                            </div>
                            <div class="option">
                                <input type="radio" id="q${questionId}_false" name="q${questionId}" value="false">
                                <label for="q${questionId}_false">Í±∞Ïßì</label>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'short_answer':
                case 'essay':
                    optionsHtml = `
                        <textarea class="text-answer" id="q${questionId}" placeholder="ÎãµÏïàÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî..."></textarea>
                    `;
                    break;
            }
            
            return `
                <div class="question-header">
                    <span class="question-number">${questionNumber}</span>
                    <span class="question-score">${subQuestion.score}Ï†ê</span>
                </div>
                <div class="question-text">${subQuestion.question}</div>
                ${optionsHtml}
            `;
        }

        function updateProgress() {
            document.getElementById('progressFill').style.width = '0%';
        }

        async function submitAnswers() {
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="loading"></span> Ï±ÑÏ†ê Ï§ë...';
            
            // ÎãµÏïà ÏàòÏßë
            collectAnswers();
            
            // Ï±ÑÏ†ê ÏàòÌñâ
            const results = await gradeAnswers();
            
            // Í≤∞Í≥º ÌëúÏãú
            showResults(results);
            
            submitBtn.disabled = false;
            submitBtn.innerHTML = 'ÎãµÏïà Ï†úÏ∂ú';
        }

        function collectAnswers() {
            userAnswers = {};
            
            currentExam.questions.forEach((question, index) => {
                if (question.type === 'compound') {
                    question.sub_questions.forEach((subQ, subIndex) => {
                        const questionId = `${question.id}-${subIndex}`;
                        userAnswers[questionId] = collectSingleAnswer(subQ, questionId);
                    });
                } else {
                    userAnswers[question.id] = collectSingleAnswer(question, question.id);
                }
            });
        }

        function collectSingleAnswer(question, questionId) {
            switch (question.type) {
                case 'single_choice':
                case 'true_false':
                    const radio = document.querySelector(`input[name="q${questionId}"]:checked`);
                    return radio ? radio.value : null;
                    
                case 'multiple_choice':
                    const checkboxes = document.querySelectorAll(`input[name="q${questionId}"]:checked`);
                    return Array.from(checkboxes).map(cb => parseInt(cb.value));
                    
                case 'short_answer':
                case 'essay':
                    const textarea = document.getElementById(`q${questionId}`);
                    return textarea ? textarea.value.trim() : '';
                    
                default:
                    return null;
            }
        }

        async function gradeAnswers() {
            const results = {};
            
            for (const question of currentExam.questions) {
                if (question.type === 'compound') {
                    for (let subIndex = 0; subIndex < question.sub_questions.length; subIndex++) {
                        const subQ = question.sub_questions[subIndex];
                        const questionId = `${question.id}-${subIndex}`;
                        const userAnswer = userAnswers[questionId];
                        
                        if (subQ.type === 'essay') {
                            results[questionId] = await gradeEssayQuestion(subQ, userAnswer);
                        } else {
                            results[questionId] = gradeObjectiveQuestion(subQ, userAnswer);
                        }
                    }
                } else {
                    const questionId = question.id;
                    const userAnswer = userAnswers[questionId];
                    
                    if (question.type === 'essay') {
                        results[questionId] = await gradeEssayQuestion(question, userAnswer);
                    } else {
                        results[questionId] = gradeObjectiveQuestion(question, userAnswer);
                    }
                }
            }
            
            return results;
        }

        function gradeObjectiveQuestion(question, userAnswer) {
            let isCorrect = false;
            let score = 0;
            
            switch (question.type) {
                case 'single_choice':
                    isCorrect = parseInt(userAnswer) === question.correct_answer;
                    score = isCorrect ? question.score : 0;
                    break;
                    
                case 'multiple_choice':
                    const correctAnswers = question.correct_answers.sort();
                    const userAnswersSorted = (userAnswer || []).sort();
                    isCorrect = JSON.stringify(correctAnswers) === JSON.stringify(userAnswersSorted);
                    score = isCorrect ? question.score : 0;
                    break;
                    
                case 'true_false':
                    const correctAnswer = question.correct_answer.toString();
                    isCorrect = userAnswer === correctAnswer;
                    score = isCorrect ? question.score : 0;
                    break;
                    
                case 'short_answer':
                    isCorrect = userAnswer && userAnswer.toLowerCase() === question.correct_answer.toLowerCase();
                    score = isCorrect ? question.score : 0;
                    break;
            }
            
            return {
                isCorrect,
                score,
                maxScore: question.score,
                userAnswer,
                correctAnswer: question.correct_answer || question.correct_answers,
                explanation: question.explanation
            };
        }

        async function gradeEssayQuestion(question, userAnswer) {
            if (!apiKey) {
                return {
                    isCorrect: false,
                    score: 0,
                    maxScore: question.score,
                    userAnswer,
                    explanation: question.explanation,
                    feedback: "API ÌÇ§Í∞Ä ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏïÑ Ï£ºÍ¥ÄÏãù Î¨∏Ï†úÎ•º Ï±ÑÏ†êÌï† Ïàò ÏóÜÏäµÎãàÎã§."
                };
            }

            if (!userAnswer || userAnswer.trim() === '') {
                return {
                    isCorrect: false,
                    score: 0,
                    maxScore: question.score,
                    userAnswer: '',
                    explanation: question.explanation,
                    feedback: "ÎãµÏïàÏù¥ ÏûÖÎ†•ÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§."
                };
            }

            // Î∏åÎùºÏö∞Ï†Ä Ï†úÌïúÏúºÎ°ú Ïù∏Ìï¥ ÏßÅÏ†ë OpenAI API Ìò∏Ï∂úÏù¥ Ïñ¥Î†§Ïö∞ÎØÄÎ°ú 
            // ÏûÑÏãúÎ°ú Í∞ÑÎã®Ìïú ÌÇ§ÏõåÎìú Í∏∞Î∞ò Ï±ÑÏ†êÏùÑ ÏÇ¨Ïö©Ìï©ÎãàÎã§.
            return gradeEssaySimple(question, userAnswer);
        }

        function gradeEssaySimple(question, userAnswer) {
            // Í∞ÑÎã®Ìïú ÌÇ§ÏõåÎìú Í∏∞Î∞ò Ï±ÑÏ†ê ÏãúÏä§ÌÖú
            const answerLower = userAnswer.toLowerCase();
            let score = 0;
            let feedback = "";
            
            // Í∏∞Î≥∏ Ï†êÏàò (ÎãµÏïàÏùÑ ÏûëÏÑ±ÌñàÏúºÎ©¥ Í∏∞Î≥∏Ï†êÏàò Î∂ÄÏó¨)
            if (userAnswer.length > 10) {
                score = Math.floor(question.score * 0.3); // 30% Í∏∞Î≥∏Ï†êÏàò
                feedback = "ÎãµÏïàÏùÑ ÏÑ±Ïã§Ìûà ÏûëÏÑ±ÌñàÏäµÎãàÎã§. ";
            }
            
            // Î¨∏Ï†úÎ≥Ñ ÌÇ§ÏõåÎìú Ï±ÑÏ†ê
            if (question.question.includes("ÌîºÌÉÄÍ≥†ÎùºÏä§")) {
                const keywords = ["a¬≤+b¬≤=c¬≤", "a^2+b^2=c^2", "ÏßÅÍ∞ÅÏÇºÍ∞ÅÌòï", "ÎπóÎ≥Ä", "Ï†úÍ≥±", "Î£®Ìä∏"];
                let keywordCount = 0;
                keywords.forEach(keyword => {
                    if (answerLower.includes(keyword.toLowerCase())) {
                        keywordCount++;
                    }
                });
                
                if (keywordCount >= 3) {
                    score = question.score; // ÎßåÏ†ê
                    feedback += "ÌîºÌÉÄÍ≥†ÎùºÏä§ Ï†ïÎ¶¨Î•º Ï†ïÌôïÌûà Ïù¥Ìï¥ÌïòÍ≥† Í≥ÑÏÇ∞ÏùÑ Ïò¨Î∞îÎ•¥Í≤å ÏàòÌñâÌñàÏäµÎãàÎã§.";
                } else if (keywordCount >= 2) {
                    score = Math.floor(question.score * 0.7); // 70%
                    feedback += "ÌîºÌÉÄÍ≥†ÎùºÏä§ Ï†ïÎ¶¨Ïùò Í∞úÎÖêÏùÄ Ïù¥Ìï¥ÌñàÏúºÎÇò ÏÑ§Î™ÖÏù¥ Î∂ÄÏ°±Ìï©ÎãàÎã§.";
                } else if (keywordCount >= 1) {
                    score = Math.floor(question.score * 0.5); // 50%
                    feedback += "ÌîºÌÉÄÍ≥†ÎùºÏä§ Ï†ïÎ¶¨Ïóê ÎåÄÌïú Í∏∞Î≥∏ Ïù¥Ìï¥Îäî ÏûàÏúºÎÇò Îçî ÏûêÏÑ∏Ìïú ÏÑ§Î™ÖÏù¥ ÌïÑÏöîÌï©ÎãàÎã§.";
                }
            }
            
            else if (question.question.includes("Îâ¥ÌÑ¥") && question.question.includes("Ï†ú3Î≤ïÏπô")) {
                const keywords = ["ÏûëÏö©", "Î∞òÏûëÏö©", "Í∞ôÏùÄ", "ÌÅ¨Í∏∞", "Î∞òÎåÄ", "Î∞©Ìñ•", "Ìûò", "Î≤ïÏπô"];
                let keywordCount = 0;
                keywords.forEach(keyword => {
                    if (answerLower.includes(keyword.toLowerCase())) {
                        keywordCount++;
                    }
                });
                
                if (keywordCount >= 4) {
                    score = question.score;
                    feedback += "Îâ¥ÌÑ¥ Ï†ú3Î≤ïÏπôÏùÑ Ï†ïÌôïÌûà ÏÑ§Î™ÖÌñàÏäµÎãàÎã§.";
                } else if (keywordCount >= 2) {
                    score = Math.floor(question.score * 0.7);
                    feedback += "Îâ¥ÌÑ¥ Ï†ú3Î≤ïÏπôÏùò Í∏∞Î≥∏ Í∞úÎÖêÏùÄ ÎßûÏúºÎÇò Îçî Ï†ïÌôïÌïú ÏÑ§Î™ÖÏù¥ ÌïÑÏöîÌï©ÎãàÎã§.";
                }
            }
            
            // ÎãµÏïà Í∏∏Ïù¥Ïóê Îî∞Î•∏ Ï∂îÍ∞Ä Ï†êÏàò Ï°∞Ï†ï
            if (userAnswer.length < 20) {
                score = Math.min(score, Math.floor(question.score * 0.4));
                feedback += " ÎãµÏïàÏù¥ ÎÑàÎ¨¥ ÏßßÏäµÎãàÎã§.";
            } else if (userAnswer.length > 100) {
                feedback += " ÏÉÅÏÑ∏Ìïú ÎãµÏïàÏùÑ ÏûëÏÑ±ÌñàÏäµÎãàÎã§.";
            }
            
            return {
                isCorrect: score === question.score,
                score: Math.min(score, question.score),
                maxScore: question.score,
                userAnswer,
                explanation: question.explanation,
                feedback: feedback || "ÎãµÏïàÏùÑ Í≤ÄÌÜ†Ìï¥Î≥¥ÏÑ∏Ïöî."
            };
        }

        // OpenAI API ÏÇ¨Ïö©ÏùÑ ÏúÑÌïú ÌîÑÎ°ùÏãú Ìï®Ïàò (ÏÑ†ÌÉùÏÇ¨Ìï≠)
        async function gradeEssayWithAPI(question, userAnswer) {
            try {
                // CORS Ïö∞ÌöåÎ•º ÏúÑÌïú ÌîÑÎ°ùÏãú ÏÑúÎπÑÏä§ ÏÇ¨Ïö© ÏòàÏãú
                // Ïã§Ï†ú ÏÇ¨Ïö©ÏãúÏóêÎäî ÏûêÏ≤¥ ÌîÑÎ°ùÏãú ÏÑúÎ≤Ñ Íµ¨Ï∂ï Í∂åÏû•
                const proxyUrl = 'https://cors-anywhere.herokuapp.com/';
                const targetUrl = 'https://api.openai.com/v1/chat/completions';
                
                const response = await fetch(proxyUrl + targetUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + apiKey,
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [
                            {
                                role: 'system',
                                content: 'You are an exam grader. Evaluate the student answer and respond with JSON: {"score": number, "feedback": "string", "isCorrect": boolean}'
                            },
                            {
                                role: 'user',
                                content: `Question: ${question.question}\nCorrect Answer Reference: ${question.explanation}\nStudent Answer: ${userAnswer}\nMax Score: ${question.score}`
                            }
                        ],
                        temperature: 0.3
                    })
                });

                if (!response.ok) {
                    throw new Error('API request failed');
                }

                const data = await response.json();
                const aiResponse = JSON.parse(data.choices[0].message.content);
                
                return {
                    isCorrect: aiResponse.score === question.score,
                    score: aiResponse.score,
                    maxScore: question.score,
                    userAnswer,
                    explanation: question.explanation,
                    feedback: aiResponse.feedback
                };
            } catch (error) {
                console.error('AI grading error:', error);
                // API Ïã§Ìå®Ïãú Í∞ÑÎã® Ï±ÑÏ†êÏúºÎ°ú fallback
                return gradeEssaySimple(question, userAnswer);
            }
        }

        function showResults(results) {
            document.getElementById('examContainer').classList.add('hidden');
            document.getElementById('resultsContainer').classList.remove('hidden');
            
            let totalScore = 0;
            let maxTotalScore = 0;
            
            // Ï†êÏàò Í≥ÑÏÇ∞
            for (const result of Object.values(results)) {
                totalScore += result.score;
                maxTotalScore += result.maxScore;
            }
            
            // Ï†êÏàò ÌëúÏãú
            const percentage = Math.round((totalScore / maxTotalScore) * 100);
            document.getElementById('finalScore').textContent = `${totalScore}/${maxTotalScore}Ï†ê (${percentage}%)`;
            
            let scoreDescription = '';
            if (percentage >= 90) {
                scoreDescription = 'üéâ ÌõåÎ•≠Ìï©ÎãàÎã§! Îß§Ïö∞ Ïö∞ÏàòÌïú ÏÑ±Ï†ÅÏûÖÎãàÎã§.';
            } else if (percentage >= 80) {
                scoreDescription = 'üëè ÏûòÌñàÏäµÎãàÎã§! Ï¢ãÏùÄ ÏÑ±Ï†ÅÏûÖÎãàÎã§.';
            } else if (percentage >= 70) {
                scoreDescription = 'üëç Í¥úÏ∞ÆÏäµÎãàÎã§! Ï°∞Í∏àÎßå Îçî ÎÖ∏Î†•ÌïòÎ©¥ Îê©ÎãàÎã§.';
            } else if (percentage >= 60) {
                scoreDescription = 'üìö Îçî Í≥µÎ∂ÄÍ∞Ä ÌïÑÏöîÌï©ÎãàÎã§.';
            } else {
                scoreDescription = 'üí™ Ìè¨Í∏∞ÌïòÏßÄ ÎßêÍ≥† Îã§Ïãú ÎèÑÏ†ÑÌï¥Î≥¥ÏÑ∏Ïöî!';
            }
            document.getElementById('scoreDescription').textContent = scoreDescription;
            
            // ÎãµÏïà Í≤ÄÌÜ† ÌëúÏãú
            const reviewsContainer = document.getElementById('answerReviews');
            reviewsContainer.innerHTML = '';
            
            let questionNumber = 1;
            
            currentExam.questions.forEach((question) => {
                if (question.type === 'compound') {
                    const compoundDiv = document.createElement('div');
                    compoundDiv.innerHTML = `<h3>${question.question}</h3>`;
                    
                    question.sub_questions.forEach((subQ, subIndex) => {
                        const questionId = `${question.id}-${subIndex}`;
                        const result = results[questionId];
                        
                        const reviewDiv = createAnswerReview(subQ, result, questionNumber);
                        compoundDiv.appendChild(reviewDiv);
                        questionNumber++;
                    });
                    
                    reviewsContainer.appendChild(compoundDiv);
                } else {
                    const result = results[question.id];
                    const reviewDiv = createAnswerReview(question, result, questionNumber);
                    reviewsContainer.appendChild(reviewDiv);
                    questionNumber++;
                }
            });
            
            setTimeout(renderMath, 100);
        }

        function createAnswerReview(question, result, questionNumber) {
            const reviewDiv = document.createElement('div');
            
            let statusClass = 'incorrect';
            let statusText = 'ÌãÄÎ¶º';
            
            if (result.isCorrect) {
                statusClass = 'correct';
                statusText = 'Ï†ïÎãµ';
            } else if (result.score > 0) {
                statusClass = 'partial';
                statusText = 'Î∂ÄÎ∂Ñ Ï†ïÎãµ';
            }
            
            reviewDiv.className = `answer-review ${statusClass}`;
            
            let userAnswerText = '';
            if (question.type === 'multiple_choice') {
                const selectedOptions = (result.userAnswer || []).map(index => question.options[index]);
                userAnswerText = selectedOptions.length > 0 ? selectedOptions.join(', ') : 'ÏÑ†ÌÉùÌïòÏßÄ ÏïäÏùå';
            } else if (question.type === 'single_choice') {
                userAnswerText = result.userAnswer !== null ? question.options[result.userAnswer] : 'ÏÑ†ÌÉùÌïòÏßÄ ÏïäÏùå';
            } else if (question.type === 'true_false') {
                userAnswerText = result.userAnswer === 'true' ? 'Ï∞∏' : result.userAnswer === 'false' ? 'Í±∞Ïßì' : 'ÏÑ†ÌÉùÌïòÏßÄ ÏïäÏùå';
            } else {
                userAnswerText = result.userAnswer || 'ÎãµÏïà ÏóÜÏùå';
            }
            
            let correctAnswerText = '';
            if (question.type === 'multiple_choice') {
                correctAnswerText = question.correct_answers.map(index => question.options[index]).join(', ');
            } else if (question.type === 'single_choice') {
                correctAnswerText = question.options[question.correct_answer];
            } else if (question.type === 'true_false') {
                correctAnswerText = question.correct_answer ? 'Ï∞∏' : 'Í±∞Ïßì';
            } else if (question.type === 'short_answer') {
                correctAnswerText = question.correct_answer;
            } else {
                correctAnswerText = 'Ï£ºÍ¥ÄÏãù Î¨∏Ï†ú';
            }
            
            reviewDiv.innerHTML = `
                <div class="status-badge ${statusClass}">${statusText} (${result.score}/${result.maxScore}Ï†ê)</div>
                <h4>Î¨∏Ï†ú ${questionNumber}: ${question.question}</h4>
                <p><strong>ÎÇ¥ ÎãµÏïà:</strong> ${userAnswerText}</p>
                ${question.type !== 'essay' ? `<p><strong>Ï†ïÎãµ:</strong> ${correctAnswerText}</p>` : ''}
                ${result.feedback ? `<p><strong>AI ÌîºÎìúÎ∞±:</strong> ${result.feedback}</p>` : ''}
                <div class="explanation">
                    <strong>Ìï¥ÏÑ§:</strong> ${result.explanation}
                </div>
            `;
            
            return reviewDiv;
        }

        function resetExam() {
            currentExam = null;
            userAnswers = {};
            
            document.getElementById('examSelector').classList.remove('hidden');
            document.getElementById('examContainer').classList.add('hidden');
            document.getElementById('resultsContainer').classList.add('hidden');
        }
    </script>
</body>
</html>
